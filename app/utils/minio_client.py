import uuid
import mimetypes
from fastapi import UploadFile
from minio import Minio
from minio.error import S3Error

# ========== CARREGAR .env ==========
import os

from app.utils.logger import logger

# S√≥ carrega .env se estiver fora do Docker
if not os.getenv("RUNNING_IN_DOCKER"):
    from dotenv import load_dotenv
    from pathlib import Path
    load_dotenv(dotenv_path=Path(__file__).resolve().parents[2] / ".env")


# ========== CONFIGURA√á√ÉO ==========
MINIO_ENDPOINT = os.getenv("MINIO_ENDPOINT")  # interno: usado para conectar
MINIO_ENDPOINT_CLEAN = (MINIO_ENDPOINT or "").replace("http://", "").replace("https://", "")
MINIO_PUBLIC_ENDPOINT = os.getenv("MINIO_PUBLIC_ENDPOINT")  # externo: usado para gerar link
MINIO_ROOT_USER = os.getenv("MINIO_ROOT_USER")
MINIO_ROOT_PASSWORD = os.getenv("MINIO_ROOT_PASSWORD")

# ========== CLIENT ==========
client = Minio(
    endpoint=MINIO_ENDPOINT_CLEAN,
    access_key=MINIO_ROOT_USER,
    secret_key=MINIO_ROOT_PASSWORD,
    secure=MINIO_ENDPOINT.startswith("https"),
)

# ========== FUN√á√ÉO DE UPLOAD ==========
def upload_file_to_minio(file: UploadFile, slug: str, bucket: str) -> str:
    try:
        logger.info(f"üîç Verificando se o bucket '{bucket}' existe...")
        if not client.bucket_exists(bucket):
            logger.info(f"üì¶ Bucket '{bucket}' n√£o existe. Criando...")
            client.make_bucket(bucket)
        else:
            logger.info(f"‚úÖ Bucket '{bucket}' j√° existe.")

        ext = mimetypes.guess_extension(file.content_type) or ".bin"
        filename = f"{uuid.uuid4()}{ext}"

        logger.info(f"‚¨ÜÔ∏è Upload: bucket='{bucket}', filename='{filename}'")

        client.put_object(
            bucket_name=bucket,
            object_name=filename,
            data=file.file,
            length=-1,
            part_size=10 * 1024 * 1024,
            content_type=file.content_type,
        )

        # ‚ö†Ô∏è Aqui agora usamos o endpoint P√öBLICO
        url = f"{MINIO_PUBLIC_ENDPOINT}/{bucket}/{filename}"
        logger.info(f"‚úÖ Upload finalizado com sucesso: {url}")
        return url

    except S3Error as e:
        logger.error(f"‚ùå Erro MinIO: {e}")
        raise
    except Exception as e:
        logger.error(f"‚ùå Erro inesperado: {e}")
        raise
