# app/database/migrations/fix_categoria_fk.py
"""
Migration espec√≠fica para corrigir a foreign key de cod_categoria
"""
import sys
import os

# Adicionar o diret√≥rio raiz do projeto ao path
current_dir = os.path.dirname(os.path.abspath(__file__))
project_root = os.path.dirname(os.path.dirname(os.path.dirname(current_dir)))
sys.path.insert(0, project_root)

from sqlalchemy import text
from app.database.db_connection import engine

def fix_categoria_foreign_key():
    """Corrige a foreign key de cod_categoria para apontar para mensura.categorias"""
    
    with engine.connect() as conn:
        trans = conn.begin()
        
        try:
            print("üîç Verificando estado atual da foreign key...")
            
            # Verificar qual foreign key est√° ativa
            result = conn.execute(text("""
                SELECT 
                    tc.constraint_name,
                    ccu.table_schema as referenced_schema,
                    ccu.table_name as referenced_table
                FROM information_schema.table_constraints tc
                JOIN information_schema.constraint_column_usage ccu 
                    ON tc.constraint_name = ccu.constraint_name
                WHERE tc.table_schema = 'mensura' 
                AND tc.table_name = 'cadprod'
                AND tc.constraint_type = 'FOREIGN KEY'
                AND ccu.column_name = 'cod_categoria';
            """))
            
            current_fk = result.fetchone()
            if current_fk:
                print(f"üìã Foreign key atual: {current_fk.constraint_name}")
                print(f"üìã Referencia: {current_fk.referenced_schema}.{current_fk.referenced_table}")
            else:
                print("‚ö†Ô∏è Nenhuma foreign key encontrada para cod_categoria")
            
            print("üîÑ Criando tabela mensura.categorias se n√£o existir...")
            
            # 1. Garantir que a tabela mensura.categorias existe
            conn.execute(text("""
                CREATE TABLE IF NOT EXISTS mensura.categorias (
                    id SERIAL PRIMARY KEY,
                    descricao VARCHAR(100) NOT NULL,
                    ativo INTEGER NOT NULL DEFAULT 1,
                    parent_id INTEGER REFERENCES mensura.categorias(id) ON DELETE SET NULL,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                );
            """))
            
            print("üîÑ Inserindo categorias padr√£o se n√£o existirem...")
            
            # 2. Inserir categorias padr√£o
            conn.execute(text("""
                INSERT INTO mensura.categorias (descricao, ativo) VALUES 
                ('Geral', 1),
                ('Bebidas', 1),
                ('Comidas', 1),
                ('Sobremesas', 1),
                ('Lanches', 1)
                ON CONFLICT DO NOTHING;
            """))
            
            print("üîÑ Removendo foreign key antiga...")
            
            # 3. Remover todas as constraints de foreign key existentes
            conn.execute(text("""
                ALTER TABLE mensura.cadprod 
                DROP CONSTRAINT IF EXISTS cadprod_cod_categoria_fkey;
            """))
            
            conn.execute(text("""
                ALTER TABLE mensura.cadprod 
                DROP CONSTRAINT IF EXISTS fk_cadprod_categoria;
            """))
            
            # 4. Tornar a coluna nullable temporariamente
            print("üîÑ Tornando coluna cod_categoria nullable...")
            conn.execute(text("""
                ALTER TABLE mensura.cadprod 
                ALTER COLUMN cod_categoria DROP NOT NULL;
            """))
            
            print("üîÑ Adicionando nova foreign key para mensura.categorias...")
            
            # 5. Adicionar nova foreign key
            conn.execute(text("""
                ALTER TABLE mensura.cadprod 
                ADD CONSTRAINT cadprod_cod_categoria_fkey 
                FOREIGN KEY (cod_categoria) REFERENCES mensura.categorias(id) ON DELETE RESTRICT;
            """))
            
            print("üîÑ Atualizando produtos sem categoria...")
            
            # 6. Atualizar produtos que n√£o t√™m categoria para usar categoria "Geral" (id=1)
            conn.execute(text("""
                UPDATE mensura.cadprod 
                SET cod_categoria = 1 
                WHERE cod_categoria IS NULL;
            """))
            
            print("üîç Verificando nova foreign key...")
            
            # Verificar se a nova foreign key foi criada
            result = conn.execute(text("""
                SELECT 
                    tc.constraint_name,
                    ccu.table_schema as referenced_schema,
                    ccu.table_name as referenced_table
                FROM information_schema.table_constraints tc
                JOIN information_schema.constraint_column_usage ccu 
                    ON tc.constraint_name = ccu.constraint_name
                WHERE tc.table_schema = 'mensura' 
                AND tc.table_name = 'cadprod'
                AND tc.constraint_type = 'FOREIGN KEY'
                AND ccu.column_name = 'cod_categoria';
            """))
            
            new_fk = result.fetchone()
            if new_fk:
                print(f"‚úÖ Nova foreign key criada: {new_fk.constraint_name}")
                print(f"‚úÖ Agora referencia: {new_fk.referenced_schema}.{new_fk.referenced_table}")
            else:
                print("‚ùå Falha ao criar nova foreign key")
            
            trans.commit()
            print("‚úÖ Foreign key corrigida com sucesso!")
            print("üéâ Agora cod_categoria referencia mensura.categorias!")
            
        except Exception as e:
            trans.rollback()
            print(f"‚ùå Erro ao corrigir foreign key: {e}")
            raise

if __name__ == "__main__":
    fix_categoria_foreign_key()
